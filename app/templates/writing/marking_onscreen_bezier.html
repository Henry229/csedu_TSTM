{% extends "ui/ui_base.html" %}
{% block title %}CSEdu Assessment System - Testset Management{% endblock %}
{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="/static/csedu_style.css">
    <style>
        .slider {
            -webkit-appearance: none;
            width: 100px;
            height: 5px;
            background: #FFFFFF;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #FFFFFF;
            cursor: pointer;
        }
    </style>
{% endblock %}
{% block app_content %}
    <form action="{{ url_for('writing.marking_edit') }}" id="marking_form" method="POST" class="form" role="form">
        {{ form.hidden_tag() }}
        <div class="card card-accent-info">
            <div class="card-header"><i class="fas fa-pencil-alt" style="color: #339af0;"></i><strong>Marking</strong>
                <span class="badge badge-info float-right">Marking of Student Writing</span>
                {{ Student.getCSStudentName(form.student_user_id.data) }}({{ Student.getCSStudentId(form.student_user_id.data) }})
            </div>
            <div class="card-body">
                <div class="row">
                    {{ form.markers_comment.label }}
                    {{ form.markers_comment(rows="8", cols="50") }}
                    <table id="weight_mapping">
                        <tbody>
                        <tr>
                            <th>Criteria</th>
                            <th>Mark</th>
                        </tr>
                        {% for criteria_form in form.markings %}
                            <tr>
                                <td> {{ criteria_form.criteria(size="3", readonly=True) }}</td>
                                <td> {{ criteria_form.marking(size="4", pattern="[0-9].[0-9]") }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div>{{ form.submit(class="btn btn-danger btn-sm", id="basic_info", value="Submit") }}
                    <button type="reset" class="btn btn-outline-danger btn-sm" data-dismiss="modal" aria-label="Close">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </form>
    <div class="card-body">
        <hr>
        <div id="marking_tools">
            <button id="marking_clear" class="btn btn-outline-danger btn-sm">Clear</button>
            <button id="marking_save" class="btn-sm ml-5"><i class="fas fa-save ml-1 mr-1"> Save Marking</i>
            </button>
            <div class="float-right">
                <button class="marking_button btn btn-danger btn-sm" onclick="colorChange(this)">Red</button>
                <button class="marking_button btn btn-primary btn-sm" onclick="colorChange(this)">Blue</button>
                <button class="marking_button btn btn-success btn-sm" onclick="colorChange(this)">Green</button>
                <button class="marking_button btn btn-warning btn-sm" onclick="colorChange(this)">Yellow</button>
                <button class="marking_button btn btn-light btn-sm" onclick="colorChange(this)">Eraser</button>
                <i id="pen-icon" class="fas fa-pen" style="font-size: 25px"><input id="pen_width" type="range"
                                                                                   class="slider" max="10" min="1"
                                                                                   value="1"></i>
            </div>
        </div>
        <div id="canvases" style="position: relative;">
            <canvas id="writing"
                    style="z-index: 1; position: absolute; left: 0px; top: 0px;">
                Student writing
                <img id="student_writing" src="{{ web_img_link }}">
            </canvas>
            <canvas id="marking"
                    style="z-index: 3; position: absolute; left: 0px; top: 0px;">
                On screen marking
            </canvas>
            <canvas id="cursor"
                    style="z-index: 2; position: absolute; left: 0px; top: 0px;">
                Cursor
            </canvas>
        </div>
    </div>
{% endblock app_content %}
{% block scripts %}
    {{ super() }}
    <script src="/static/common/js/csedu_common.js"></script>
    <script src="/static/writing/js/manage.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            writing_layer = document.getElementById("writing");
            writing_ctx = writing_layer.getContext("2d");
            marking_layer = document.getElementById("marking");
            cursor_layer = document.getElementById("cursor");

            card_body = $("div.card-body");
            var img = document.getElementById("student_writing");
            ratio = img.height / img.width;
            writing_layer.width = card_body.width();
            writing_layer.height = writing_layer.width * ratio;
            marking_layer.width = card_body.width();
            marking_layer.height = writing_layer.width * ratio;
            cursor_layer.width = card_body.width();
            cursor_layer.height = writing_layer.width * ratio;

            writing_ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, writing_layer.width, writing_layer.height);
        })

        function midPointBtw(p1, p2) {
            return {
                x: p1.x + (p2.x - p1.x) / 2,
                y: p1.y + (p2.y - p1.y) / 2
            };
        }

        var marking_layer = document.getElementById('marking');
        var marking_ctx = marking_layer.getContext('2d');
        var cursor_layer = document.getElementById("cursor");
        var cursor_ctx = cursor_layer.getContext('2d');
        var penColor;
        var penWidth;
        var eraserMode;
        var alpha = 0.1;
        var isDrawing, points = [];

        function init_marker() {
            penColor = "rgba(246,72,70, " + alpha + ")";
            penWidth = 2;
            eraserMode = false;
            $("#pen_width").val(penWidth);
            $("#pen-icon").css('color', "rgb(246,72,70)");
            $(".slider").css('background', "rgb(246,72,70)");
            marking_ctx.globalCompositeOperation = 'source-over';
            $("#pen-icon").removeClass("fa-eraser").addClass("fa-pen");
        }

        marking_layer.onmousedown = function (e) {
            isDrawing = true;
            var d = marking_layer.getBoundingClientRect();
            points.push({x: e.clientX - d.left, y: e.clientY - d.top});
        };

        marking_layer.onmousemove = function (e) {
            var d = marking_layer.getBoundingClientRect();
            var mouse_x = e.clientX - d.left;
            var mouse_y = e.clientY - d.top;

            cursor_ctx.clearRect(0, 0, marking_layer.width, marking_layer.height);
            cursor_ctx.strokeStyle = penColor;
            cursor_ctx.beginPath();
            cursor_ctx.arc(mouse_x, mouse_y, penWidth / 2, 0, 2 * Math.PI);
            cursor_ctx.stroke();

            if (!isDrawing) return;

            points.push({x: mouse_x, y: mouse_y});

            var p1 = points[0];
            var p2 = points[1];

            marking_ctx.beginPath();
            marking_ctx.moveTo(p1.x, p1.y);

            for (var i = 1, len = points.length; i < len; i++) {
                // we pick the point between pi+1 & pi+2 as the
                // end point and p1 as our control point
                var midPoint = midPointBtw(p1, p2);
                marking_ctx.quadraticCurveTo(p1.x, p1.y, midPoint.x, midPoint.y);
                p1 = points[i];
                p2 = points[i + 1];
            }
            // Draw last line as a straight line while
            // we wait for the next point to be able to calculate
            // the bezier control point
            if (eraserMode) {
                marking_ctx.beginPath();
                marking_ctx.arc(mouse_x, mouse_y, penWidth / 2, 0, 2 * Math.PI);
                marking_ctx.fill();
            } else {
                marking_ctx.lineTo(p1.x, p1.y);
                marking_ctx.strokeStyle = penColor;
                marking_ctx.lineWidth = penWidth;
                marking_ctx.stroke();
            }
        };

        marking_layer.onmouseup = function () {
            isDrawing = false;
            points.length = 0;
            cursor_ctx.clearRect(0, 0, marking_layer.width, marking_layer.height);
        };

        document.getElementById("marking_clear").onclick = function () {
            if (confirm("Are you sure to clear? Can't undo")) {
                marking_ctx.clearRect(0, 0, marking_ctx.canvas.width, marking_ctx.canvas.height);
                init_marker();
            }
        }

        function colorChange(button) {
            if (button.innerHTML === "Eraser") {
                eraserMode = true;
                marking_ctx.globalCompositeOperation = 'destination-out';
                penColor = "grey";
                penWidth = $("#pen_width").val() * 10;
                $("#pen-icon").css('color', "Grey");
                $("#pen-icon").removeClass("fa-pen").addClass("fa-eraser");
                $(".slider").css('background', "Grey");
            } else {
                eraserMode = false;
                marking_ctx.globalCompositeOperation = 'source-over';
                penWidth = $("#pen_width").val();
                $("#pen-icon").removeClass("fa-eraser").addClass("fa-pen");

                switch (button.innerHTML) {
                    case "Red":
                        penColor = "rgba(246, 72, 70, 1)";
                        $("#pen-icon").css('color', "rgb(246, 72, 70)");
                        $(".slider").css('background', "rgb(246, 72, 70)");
                        break;
                    case "Green":
                        penColor = "rgba(62, 166, 98, 1)";
                        $("#pen-icon").css('color', "rgb(62, 166, 98)");
                        $(".slider").css('background', "rgb(62, 166, 98)");
                        break;
                    case "Blue":
                        penColor = "rgba(27, 142, 183, 1)";
                        $("#pen-icon").css('color', "rgb(27, 142, 183)");
                        $(".slider").css('background', "rgb(27, 142, 183)");
                        break;
                    case "Yellow":
                        penColor = "rgba(255, 193, 7, 1)";
                        $("#pen-icon").css('color', "rgb(255, 193, 7)");
                        $(".slider").css('background', "rgb(255, 193, 7)");
                        break;
                    default:
                        penColor = "rgba(246, 72, 70, 1)";
                        $("#pen-icon").css('color', "rgb(246, 72, 70)");
                        $(".slider").css('background', "rgb(246, 72, 70)");
                }
            }
        }

        var changeWidth = function () {
            if (eraserMode)
                penWidth = $("#pen_width").val() * 10;
            else
                penWidth = $("#pen_width").val();
        };

        $("#pen_width").change(changeWidth);

        init_marker();
    </script>
{% endblock scripts %}



