{% extends "ui/ui_base.html" %}
{% block title %}CSEdu Assessment System - Testset Management{% endblock %}
{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="/static/csedu_style.css">
    <link href="/static/ui/vendors/literallycanvas-0.4.14/css/literallycanvas.css" rel="stylesheet">
    <!-- dependency: React.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="/static/ui/vendors/literallycanvas-0.4.14/js/literallycanvas.js"></script>
{% endblock %}
{% block app_content %}
    <form action="{{ url_for('writing.marking_edit') }}" id="marking_form" method="POST" class="form" role="form">
        {{ form.hidden_tag() }}
        <div class="card card-accent-info">
            <div class="card-header"><i class="fas fa-pencil-alt" style="color: #339af0;"></i><strong>Marking</strong>
                <span class="badge badge-info float-right">Marking of Student Writing</span>
                {{ Student.getCSStudentName(form.student_id.data) }}({{ Student.getCSStudentId(form.student_id.data) }})
            </div>
            <div class="card-body">
                <div class="row">
                    {{ form.markers_comment.label }}
                    {{ form.markers_comment(rows="8", cols="50") }}
                    <table id="weight_mapping">
                        <tbody>
                        <tr>
                            <th>Criteria</th>
                            <th>Mark</th>
                        </tr>
                        {% for criteria_form in form.markings %}
                            <tr>
                                <td> {{ criteria_form.criteria(size="3", readonly=True) }}</td>
                                <td> {{ criteria_form.marking(size="4", pattern="[0-9].[0-9]") }}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div>{{ form.submit(class="btn btn-danger btn-sm", id="basic_info", value="Submit") }}
                    <button type="reset" class="btn btn-outline-danger btn-sm" data-dismiss="modal" aria-label="Close">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </form>
    <div class="card-body">
        <hr>
        <button id = "marking_clear" class="btn btn-outline-danger btn-sm">Clear</button>
        <button class="marking_button btn btn-danger btn-sm" onclick="colorChange(this)">Red</button>
        <button class="marking_button btn btn-primary btn-sm" onclick="colorChange(this)">Blue</button>
        <button class="marking_button btn btn-success btn-sm" onclick="colorChange(this)">Green</button>
        <button class="marking_button btn btn-warning btn-sm" onclick="colorChange(this)">Yellow</button>

        <div id="canvases" style="position: relative;">
            <canvas id="writing"
                    style="z-index: 1; position: absolute; left: 0px; top: 0px;">
                Student writing
                <img id="student_writing" src="{{ web_img_link }}">
            </canvas>
            <canvas id="marking"
                    style="z-index: 2; position: absolute; left: 0px; top: 0px;">
                On screen marking
            </canvas>
        </div>
    </div>


{% endblock app_content %}
{% block scripts %}
    {{ super() }}
    <script src="/static/common/js/csedu_common.js"></script>
    <script src="/static/writing/js/manage.js"></script>
    <script src="/static/writing/js/responsive-sketchpad.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            writing_layer = document.getElementById("writing");
            writing_ctx = writing_layer.getContext("2d");
            marking_layer = document.getElementById("marking");
            marking_ctx = marking_layer.getContext("2d");

            card_body = $("div.card-body");
            var img = document.getElementById("student_writing");
            ratio = img.height / img.width;
            writing_layer.width = card_body.width();
            writing_layer.height = writing_layer.width * ratio;
            marking_layer.width = card_body.width();
            marking_layer.height = writing_layer.width * ratio;

            writing_ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, writing_layer.width, writing_layer.height);
        })

        function resizeCanvas() {
            writing_layer = document.getElementById("writing");
            writing_ctx = writing_layer.getContext("2d");
            marking_layer = document.getElementById("marking");
            marking_ctx = marking_layer.getContext("2d");

            card_body = $("div.card-body");
            var img = document.getElementById("student_writing");
            ratio = img.height / img.width;
            new_width = card_body.width();
            new_height = new_width * ratio;

            writing_ctx.canvas.width = new_width;
            writing_ctx.canvas.height = new_height;
            marking_ctx.canvas.width = new_width;
            marking_ctx.canvas.height = new_height;

            writing_ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, writing_layer.width, writing_layer.height);
        }


        function midPointBtw(p1, p2) {
            return {
                x: p1.x + (p2.x - p1.x) / 2,
                y: p1.y + (p2.y - p1.y) / 2
            };
        }

        var el = document.getElementById('marking');
        var ctx = el.getContext('2d');
        var penColor = "red";

        ctx.lineWidth = 20;
        ctx.lineJoin = ctx.lineCap = 'round';

        var isDrawing, points = [];

        el.onmousedown = function (e) {
            isDrawing = true;
            points.push({x: e.clientX, y: e.clientY});
        };

        el.onmousemove = function (e) {
            if (!isDrawing) return;

            points.push({x: e.clientX, y: e.clientY});

            {#ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);#}

            var p1 = points[0];
            var p2 = points[1];

            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);

            for (var i = 1, len = points.length; i < len; i++) {
                // we pick the point between pi+1 & pi+2 as the
                // end point and p1 as our control point
                var midPoint = midPointBtw(p1, p2);
                ctx.quadraticCurveTo(p1.x, p1.y, midPoint.x, midPoint.y);
                p1 = points[i];
                p2 = points[i + 1];
            }
            // Draw last line as a straight line while
            // we wait for the next point to be able to calculate
            // the bezier control point
            ctx.lineTo(p1.x, p1.y);
            ctx.strokeStyle = penColor;
            ctx.stroke();
        };

        el.onmouseup = function () {
            isDrawing = false;
            points.length = 0;
        };

        document.getElementById("marking_clear").onclick = function () {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

        function colorChange(button) {
            penColor = button.innerHTML;
        }

    </script>
{% endblock scripts %}



